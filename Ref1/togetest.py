import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
import pandas as pd
import random
import os

# 要爬取的 appID 列表
app_ids = [
    2358720, 1623730, 1245620, 1966720, 553850, 892970, 1326470, 1794680,
    1426210, 1293830, 1517290, 1551360, 1063730, 990080, 1144200, 1604030,
    2195250, 2567870, 1274570, 1868140, 1942280, 1468810, 534380, 671860,
    1313140, 1142710, 1943950, 1446780, 1509960, 1621690, 1987080, 1832640,
    1593500, 1248130, 2670630, 1203620, 2050650, 1332010, 1092790, 1363080,
    1716740, 2183900, 1366540, 2399830, 1260320, 1259420, 1466860, 1817070,
    1435790, 1919590, 1196590, 924970, 1687950, 1361210, 1364780, 2054970,
    1774580, 1328670, 1145350, 1244460, 1465360, 1206560, 2379780, 1282100,
    1062090, 2881650, 1282730, 1948280, 1454400, 858820, 2835570, 1135690,
    1210320, 1599600, 2322560, 1824220, 920210, 1888160, 1557740, 680420,
    2338770, 1659040, 1451940, 1290000, 1296830, 529340, 1178830, 1190000,
    1966900, 1286680, 1562430, 1527950, 2208920, 949230, 1304930, 2321470,
    1657630, 2344520, 633230, 2231380, 1629520, 1284190, 1384160, 1922560,
    2109460, 1455840, 1462040, 1401590, 2252570, 1846380, 1149620, 1817190,
    1584090, 1119730, 1669980, 2479810, 930210, 699130, 2369390, 2215430,
    1149460, 1350650, 2066020, 860510, 1693980, 1637320, 1888930, 1341290,
    1790600, 2519060, 1127500, 881020, 1432860, 1029690, 2218750, 1371580,
    1084600, 1184370, 1325200, 2221490, 1929610, 1515210, 1336490, 668580,
    1522820, 400750, 1044720, 975370, 756800, 1627720, 1703340, 1337520,
    1124300, 1062520, 1850570, 2334730, 740130, 1272080, 1252330, 2080690,
    1677280, 1778820, 997010, 1369630, 979690, 1296610, 1288310, 1948980,
    774801, 2231450, 1088850, 747660, 2290180, 1985810, 1817230, 2239150,
    2186680, 1549970, 1029780, 2212330, 2161700, 1605220, 954850, 1672970,
    1371980, 1158160, 780310, 1273400, 2108330, 2406770, 1268750, 1338770,
    368260, 1659420, 1850740, 2273430, 1940340, 2593370, 1113560, 1669000,
    799600, 894020, 1971870, 1361510, 1525700, 1385380, 1577120, 2000950,
    1466640, 2427700, 427410, 2248760, 629820, 1583320, 2420110, 867210,
    1488200, 1718570, 1331550, 1128920, 774181, 1404850, 1501750, 1574580,
    1676840, 1533390, 1388880, 2138710, 784080, 1563180, 872670, 1874880,
    775500, 1451190, 1611600, 1715130, 700600, 2239550, 1583230, 1859910,
    1034140, 2071280, 1171690, 885970, 990630, 986130, 1562700, 2005010,
    1475810, 1465460, 1934680, 1262350, 553420, 1458140, 2163330, 1928980,
    1782120, 1182900, 1761390, 1954200, 1740720, 1789480, 1533420, 1971650,
    1556790, 1785150, 597820, 1876890, 1059990, 1382330, 1040200, 1601580,
    1276790, 2072450, 1931770, 1496790, 977880, 1880330, 1277400, 1544020,
    1388770, 1061910, 1237320, 1433140, 2378900, 1989270, 1448440, 2646460,
    1611910, 1105670, 1283410, 1150440, 1592190, 2142790, 2532550, 1490890,
    1548850, 813230, 1895880, 1084160, 2322010, 2114740, 1424330, 1543030,
    1244090, 1686940, 669330, 2181930, 1559390, 2828860, 2296990, 1520370,
    1113120, 1421250, 875210, 1887840, 1809540, 2291760, 1681430, 1746030,
    1372280, 2124490, 1674170, 835960, 1202130, 2365810, 1566690, 2075070,
    607080, 1766740, 936790, 2285150, 698670, 1353230, 315210, 1504570,
    488860, 1938010, 2340650, 2027330, 1063660, 1170950, 3070070, 2669320
]

# 设置 ChromeDriver 的路径
service = Service(ChromeDriverManager().install())

# 创建一个 Excel 文件
output_file = "steam_data.xlsx"

# 初始创建 Excel 文件
with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
    for app_id in app_ids:
        url = f"https://www.togeproductions.com/SteamScout/steamAPI.php?appID={app_id}"

        # 初始化 Selenium WebDriver
        driver = webdriver.Chrome(service=service)
        driver.get(url)

        # 随机等待页面加载，时间范围从 40 到 70 秒
        time.sleep(random.randint(40, 70))

        # 获取页面内容
        html = driver.page_source

        # 使用 pandas 读取 HTML 中的表格
        try:
            tables = pd.read_html(html)
            if tables:  # 检查是否有表格
                df = tables[0]

                # 对调第一列和第二列，包括标题
                if df.shape[1] >= 2:  # 确保有至少两列
                    # 交换列标题
                    df.columns = [df.columns[1], df.columns[0]] + list(df.columns[2:])
                    # 交换数据
                    df.iloc[:, [0, 1]] = df.iloc[:, [1, 0]].values

                # 将数据写入 Excel，表名为 appID
                df.to_excel(writer, sheet_name=str(app_id), index=False)
                print(f"数据已保存到 {output_file} 的工作表 {app_id}")
            else:
                print(f"No tables found for appID: {app_id}")
        except Exception as e:
            print(f"Error reading tables for appID {app_id}: {e}")

        # 关闭浏览器
        driver.quit()

print(f"所有数据已保存到 {output_file}")